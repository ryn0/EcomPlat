@model EcomPlat.Data.Models.Product

@{
    this.ViewData["Title"] = "Edit Product";
}

<h2>@this.ViewData["Title"]</h2>

<!-- Main product form including file upload input -->
<form asp-action="Edit" method="post" enctype="multipart/form-data">
    <input type="hidden" asp-for="ProductId" />
    @await Html.PartialAsync("_ProductForm", this.Model)
    <button type="submit" class="btn btn-primary">Save Changes</button>
</form>

<!-- Separate section for displaying existing images with delete buttons -->
@if (this.Model.Images != null && this.Model.Images.Any())
{
    <div class="mt-3">
        <h4>Existing Product Images</h4>
        <div class="d-flex flex-wrap">
            @foreach (var image in this.Model.Images)
            {
                <div class="m-1 text-center" style="width: 100px;">
                    <img src="@image.ImageUrl" alt="Product Image" class="img-thumbnail" style="max-width: 100%; max-height: 100%;" />
                    <button type="button" class="btn btn-sm btn-danger delete-image-btn"
                            data-image-id="@image.ProductImageId"
                            data-product-id="@this.Model.ProductId">
                        Delete
                    </button>
                </div>
            }
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // Retrieve anti-forgery token from the hidden input rendered by @Html.AntiForgeryToken()
            var token = $('input[name="__RequestVerificationToken"]').first().val();
            $(".delete-image-btn").click(function (e) {
                e.preventDefault();
                var btn = $(this);
                var imageId = btn.data("image-id");
                var productId = btn.data("product-id");
                if (confirm("Are you sure you want to delete this image?")) {
                    $.ajax({
                        url: '@Url.Action("DeleteImage", "Products", new { area = "Admin" })',
                        type: "POST",
                        data: { imageId: imageId, productId: productId },
                        headers: { "RequestVerificationToken": token },
                        success: function () {
                            btn.closest("div.m-1").remove();
                        },
                        error: function () {
                            alert("An error occurred while deleting the image.");
                        }
                    });
                }
            });
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
